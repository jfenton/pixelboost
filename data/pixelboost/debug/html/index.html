<!DOCTYPE html>
<html>
	<head>
  	<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
    <link type="text/css" href="css/smoothness/jquery-ui-1.8.16.custom.css" rel="Stylesheet" />	
    <link type="text/css" href="css/theme.css" rel="Stylesheet"/>
    <script type="text/javascript" src="js/jquery-1.6.4.min.js"></script>
    <script type="text/javascript" src="js/jquery-ui-1.8.16.custom.min.js"></script>
    <script type="text/javascript">
      //var ajaxPrefix = 'http://127.0.0.1:9091/'; // For development
      var ajaxPrefix = '/'; // For deployment
      
      function sendVariable(type, name)
      {
        var data = "{}";
      
      	switch (type)
      	{
          case 'bool':
            data = '{ "value" : ' + $("#"+name+"_button").val() + ' }';
            break;
              	
          case 'int':
          case 'float':
            data = '{ "value" : ' + $("#"+name+"_value").val() + ' }';
            break;
          		
          case 'color':
            data = '{ "value" : { "r" : ' + $("#"+name+"_r").val() + ', "g" : ' + $("#"+name+"_g").val() + ', "b" : ' + $("#"+name+"_b").val() + ', "a" : ' + $("#"+name+"_a").val() + '} }';
            break;
          		
          case 'string':
            data = '{ "value" : "' + $("#"+name+"_value").val() + '" }';
            break;
        }
      
        $.ajax({
          type: 'PUT',
          url: ajaxPrefix+'variable/'+name+'/',
          contentType: 'application/json',
          data: data,
          complete : function() {
            $.getJSON(ajaxPrefix+'variable/'+name+'/', function(data) {
              if (data["modified"])
              {
                $('#'+name+'_title').addClass('modified');
                $('#'+name+'_reset').show();
              }
              else
              {
                $('#'+name+'_title').removeClass('modified');
                $('#'+name+'_reset').hide();
              }
            });
          }
        });
      }
    
      $(function(){
        $.getJSON(ajaxPrefix+'variables/', function(data) {
          var items = [];

          var strings = [];
          var numbers = [];
          var bools = [];
          var functions = [];
          var colors = [];
        
          $.each(data, function(key, val) {
          	var variable = val["id"];
          	
          	var contents = "<p class='variableTitle' id='"+variable+"_title'>" + val["name"] + "</p>";
          	
          	contents += "<button class='reset' id='"+variable+"_reset'>Reset</button>";
            
            switch (val["type"])
            {
            case 'bool':
            	bools.push({key: key, value: val["value"]});
            	contents += "<input type='checkbox' class='variableButton' id='"+variable+"_button'/><label for='"+variable+"_button'>Check</label>";
            	break;
          	case 'function':
          		functions.push(key);
          		contents += "<button class='variableButton' id='"+variable+"_button'>Activate</button>";
          		break;
            case 'string':
              strings.push(key);
              contents += "<textarea class='stringText' rows='1' id='"+variable+"_value'>"+val["value"]+"</textarea>";
              break;
            case 'int':
            case 'float':
              numbers.push(key);
              // Round to 3 s.f.
            	var value = val["type"] == "float" ? Math.round(val["value"]*1000)/1000 : val["value"];
              contents += "<textarea class ='variableText' id='"+variable+"_value' rows='1'>"+value+"</textarea>";
              contents += "<div class='variableSlider' id='"+variable+"_slider'></div>";
              break;
            case 'color':
            	colors.push(key);
            	contents += "<textarea class ='variableText' id='"+variable+"_r' rows='1'>"+val["value"]["r"]+"</textarea>";
            	contents += "<textarea class ='variableText' id='"+variable+"_g' rows='1'>"+val["value"]["g"]+"</textarea>";
            	contents += "<textarea class ='variableText' id='"+variable+"_b' rows='1'>"+val["value"]["b"]+"</textarea>";
            	contents += "<textarea class ='variableText' id='"+variable+"_a' rows='1'>"+val["value"]["a"]+"</textarea>";
           		break;
            }
            
            items.push('<li class="variableItem" id="' + variable + '">' + contents + '</li>');
          });
        
          $('<ul/>', {
          	'class': 'variables',
            html: items.join('')
          }).appendTo('#content');
          
          $.each(data, function(key, val) {
            $("#"+val["id"]+"_reset").button(
              {icons: {primary: "ui-icon-pencil"}, text: false}).val(val.value ? "true" : "false").change(function() {
              });
            
            if (val["modified"])
              $('#'+val["id"]+"_title").addClass('modified');
            else
              $('#'+val["id"]+"_reset").hide();
          });
          
          $.each(strings, function(key, val) {
            $("#"+data[val]["id"]+"_value").keyup(function() { sendVariable(data[val]["type"], data[val]["id"]); });
          });
          
          $.each(numbers, function(key, val) {
          	var step = 1;
          	if (data[val]["type"] == "float")
              	step = 0.001;
              	
          	var slider = $("#"+data[val]["id"]+"_slider");
          	var text = $("#"+data[val]["id"]+"_value");
          	
            slider.slider({
            	min : data[val]["min"],
            	max : data[val]["max"],
            	step : step,
            	value : data[val]["value"],
              slide : function(event, ui) {
              	$('#'+data[val]["id"]+"_value").val(ui.value);
              	sendVariable(data[val]["type"], data[val]["id"]);
              },
          	  change : function(event, ui) {
          	    if (event.originalEvent != undefined)
          	    {
            	    $('#'+data[val]["id"]+"_value").val(ui.value);
                	sendVariable(data[val]["type"], data[val]["id"]);
              	}
            	}
            	});
            	
          	text.keyup(function() {
          		sendVariable(data[val]["type"], data[val]["id"]);
          		slider.slider('value', $("#"+data[val]["id"]+"_value").val());
          	});
          });
          
          $.each(colors, function(key, val) {
              $("#"+data[val]["id"]+"_r").keyup(function() {sendVariable(data[val]["type"], data[val]["id"]);})
              $("#"+data[val]["id"]+"_g").keyup(function() {sendVariable(data[val]["type"], data[val]["id"]);})
              $("#"+data[val]["id"]+"_b").keyup(function() {sendVariable(data[val]["type"], data[val]["id"]);})
              $("#"+data[val]["id"]+"_a").keyup(function() {sendVariable(data[val]["type"], data[val]["id"]);})
          });
          
          $.each(bools, function(key, val) {
            var but = $("#"+data[val.key]["id"]+"_button");
          	but.prop('checked', val.value).button({icons: {primary: val.value ? "ui-icon-check" : "ui-icon-close"}, text: false}).val(val.value ? "true" : "false").change(function() {
          		if (but.val() == "true")
          		{
              		but.button({icons: {primary: "ui-icon-close"}, text: false});
              		but.val("false");
          		}
          		else
          		{
              		but.button({icons: {primary: "ui-icon-check"}, text: false});
              		but.val("true");
          		}
          		
          		sendVariable(data[val.key]["type"], data[val.key]["id"]);
          	});
          });
          
          $.each(functions, function(key, val) {
          	$("#"+data[val]["id"]+"_button").button({icons: {primary: "ui-icon-play"}, text: true}).click(function() {sendVariable(data[val]["type"], data[val]["id"]);});
          });
        });
      });
    </script>
  </head>
  <body>
    <p class='header'>DebugScope</p>
    <div id='content'></div>
    <p class='footer'>DebugScope developed by <a href="http://www.pixelballoon.com/">Pixel Balloon</a></p>
  </body>
</html>
